<!DOCTYPE html>
<html>
<head>
    <title>Direct Auth Fix</title>
</head>
<body>
    <script>
        // DIRECT AUTH FIX - Run this immediately
        (function() {
            console.log('üî• DIRECT AUTH FIX STARTING...');
            
            // Wait for page to load
            function waitForElements() {
                const signInModal = document.getElementById('signInModal');
                const signUpModal = document.getElementById('signUpModal');
                const signInForm = document.getElementById('signInForm');
                const signUpForm = document.getElementById('signUpForm');
                
                if (!signInModal || !signUpModal || !signInForm || !signUpForm) {
                    setTimeout(waitForElements, 500);
                    return;
                }
                
                console.log('‚úÖ DIRECT: Found all required elements');
                
                // FORCE OVERRIDE ALL FUNCTIONS
                window.openSignInModal = function() {
                    console.log('üîë DIRECT: Opening Sign In Modal');
                    signInModal.classList.remove('hidden');
                    signInModal.style.display = 'flex';
                    signInModal.style.opacity = '1';
                    signInModal.style.visibility = 'visible';
                    
                    const emailInput = document.getElementById('signInEmail');
                    if (emailInput) {
                        setTimeout(() => emailInput.focus(), 100);
                    }
                };
                
                window.openSignUpModal = function() {
                    console.log('üìù DIRECT: Opening Sign Up Modal');
                    signUpModal.classList.remove('hidden');
                    signUpModal.style.display = 'flex';
                    signUpModal.style.opacity = '1';
                    signUpModal.style.visibility = 'visible';
                    
                    const nameInput = document.getElementById('signUpName');
                    if (nameInput) {
                        setTimeout(() => nameInput.focus(), 100);
                    }
                };
                
                window.closeSignInModal = function() {
                    signInModal.classList.add('hidden');
                    signInModal.style.display = 'none';
                    signInForm.reset();
                };
                
                window.closeSignUpModal = function() {
                    signUpModal.classList.add('hidden');
                    signUpModal.style.display = 'none';
                    signUpForm.reset();
                };
                
                window.switchToSignUp = function() {
                    window.closeSignInModal();
                    setTimeout(window.openSignUpModal, 100);
                };
                
                window.switchToSignIn = function() {
                    window.closeSignUpModal();
                    setTimeout(window.openSignInModal, 100);
                };
                
                // AUTHENTICATION FUNCTIONS
                window.handleSignIn = function(event) {
                    if (event) event.preventDefault();
                    console.log('üîë DIRECT: Processing Sign In');
                    
                    const email = document.getElementById('signInEmail')?.value?.trim()?.toLowerCase();
                    const password = document.getElementById('signInPassword')?.value?.trim();
                    
                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return false;
                    }
                    
                    if (!email.includes('@') || !email.includes('.')) {
                        alert('Please enter a valid email address');
                        return false;
                    }
                    
                    try {
                        const users = JSON.parse(localStorage.getItem('visualVibeUsers') || '[]');
                        console.log(`üîç DIRECT: Checking ${users.length} users for ${email}`);
                        
                        const user = users.find(u => 
                            u.email && u.email.toLowerCase() === email && u.password === password
                        );
                        
                        if (user) {
                            console.log('‚úÖ DIRECT: Sign in successful for', user.name);
                            
                            const sessionUser = {
                                id: user.id,
                                name: user.name,
                                email: user.email,
                                firstName: user.firstName || user.name.split(' ')[0],
                                signedIn: true,
                                loginTime: new Date().toISOString()
                            };
                            
                            window.currentUser = sessionUser;
                            localStorage.setItem('visualVibeUser', JSON.stringify(sessionUser));
                            
                            updateUI();
                            window.closeSignInModal();
                            alert(`Welcome back, ${sessionUser.firstName}!`);
                            
                        } else {
                            const existingUser = users.find(u => u.email && u.email.toLowerCase() === email);
                            if (existingUser) {
                                alert('Incorrect password. Please try again.');
                            } else {
                                alert('No account found with this email. Please sign up first.');
                            }
                        }
                    } catch (error) {
                        console.error('Sign in error:', error);
                        alert('Sign in failed. Please try again.');
                    }
                    
                    return false;
                };
                
                window.handleSignUp = function(event) {
                    if (event) event.preventDefault();
                    console.log('üìù DIRECT: Processing Sign Up');
                    
                    const name = document.getElementById('signUpName')?.value?.trim();
                    const email = document.getElementById('signUpEmail')?.value?.trim()?.toLowerCase();
                    const password = document.getElementById('signUpPassword')?.value?.trim();
                    const confirm = document.getElementById('signUpConfirmPassword')?.value?.trim();
                    
                    if (!name || !email || !password || !confirm) {
                        alert('Please fill in all fields');
                        return false;
                    }
                    
                    if (!email.includes('@') || !email.includes('.')) {
                        alert('Please enter a valid email address');
                        return false;
                    }
                    
                    if (password.length < 6) {
                        alert('Password must be at least 6 characters long');
                        return false;
                    }
                    
                    if (password !== confirm) {
                        alert('Passwords do not match');
                        return false;
                    }
                    
                    try {
                        const users = JSON.parse(localStorage.getItem('visualVibeUsers') || '[]');
                        console.log(`üìù DIRECT: Checking ${users.length} users for duplicate ${email}`);
                        
                        const existingUser = users.find(u => u.email && u.email.toLowerCase() === email);
                        if (existingUser) {
                            alert('An account with this email already exists. Please sign in instead.');
                            return false;
                        }
                        
                        const newUser = {
                            id: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 8),
                            name: name,
                            firstName: name.split(' ')[0] || '',
                            lastName: name.split(' ').slice(1).join(' ') || '',
                            email: email,
                            password: password,
                            orders: [],
                            reviews: [],
                            createdAt: new Date().toISOString()
                        };
                        
                        users.push(newUser);
                        localStorage.setItem('visualVibeUsers', JSON.stringify(users));
                        console.log('‚úÖ DIRECT: New user created:', newUser.name);
                        
                        const sessionUser = {
                            id: newUser.id,
                            name: newUser.name,
                            email: newUser.email,
                            firstName: newUser.firstName,
                            signedIn: true,
                            loginTime: new Date().toISOString()
                        };
                        
                        window.currentUser = sessionUser;
                        localStorage.setItem('visualVibeUser', JSON.stringify(sessionUser));
                        
                        updateUI();
                        window.closeSignUpModal();
                        alert(`Welcome, ${newUser.firstName}! Your account has been created successfully.`);
                        
                    } catch (error) {
                        console.error('Sign up error:', error);
                        alert('Sign up failed. Please try again.');
                    }
                    
                    return false;
                };
                
                window.signOut = function() {
                    window.currentUser = null;
                    localStorage.removeItem('visualVibeUser');
                    updateUI();
                    alert('You have been signed out successfully');
                };
                
                function updateUI() {
                    try {
                        const user = window.currentUser;
                        const signedOutState = document.getElementById('signedOutState');
                        const signedInState = document.getElementById('signedInState');
                        const userNameSpan = document.getElementById('userName');
                        
                        if (user) {
                            if (signedOutState) signedOutState.style.display = 'none';
                            if (signedInState) signedInState.style.display = 'flex';
                            if (userNameSpan) userNameSpan.textContent = user.name;
                            console.log('‚úÖ DIRECT: UI updated to signed in state');
                        } else {
                            if (signedOutState) signedOutState.style.display = 'flex';
                            if (signedInState) signedInState.style.display = 'none';
                            console.log('‚úÖ DIRECT: UI updated to signed out state');
                        }
                    } catch (error) {
                        console.error('UI update error:', error);
                    }
                }
                
                window.updateAuthUI = updateUI;
                
                // SETUP FORM LISTENERS
                signInForm.onsubmit = window.handleSignIn;
                signUpForm.onsubmit = window.handleSignUp;
                
                // SETUP BUTTON LISTENERS
                const signInButtons = document.querySelectorAll('button[onclick*="openSignInModal"]');
                const signUpButtons = document.querySelectorAll('button[onclick*="openSignUpModal"]');
                
                signInButtons.forEach(btn => {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        window.openSignInModal();
                    };
                });
                
                signUpButtons.forEach(btn => {
                    btn.onclick = function(e) {
                        e.preventDefault();
                        window.openSignUpModal();
                    };
                });
                
                // RESTORE SESSION
                try {
                    const savedUser = JSON.parse(localStorage.getItem('visualVibeUser') || 'null');
                    if (savedUser && savedUser.signedIn) {
                        window.currentUser = savedUser;
                        updateUI();
                        console.log('üîÑ DIRECT: Session restored for', savedUser.name);
                    }
                } catch (error) {
                    console.log('üîÑ DIRECT: No session to restore');
                }
                
                console.log('üî• DIRECT AUTH FIX COMPLETE!');
                console.log('üìä DIRECT: Functions available:', {
                    openSignInModal: typeof window.openSignInModal,
                    openSignUpModal: typeof window.openSignUpModal,
                    handleSignIn: typeof window.handleSignIn,
                    handleSignUp: typeof window.handleSignUp
                });
            }
            
            // Start waiting for elements
            waitForElements();
        })();
    </script>
</body>
</html>
