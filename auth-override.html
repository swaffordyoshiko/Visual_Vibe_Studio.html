<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Fix Injector</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f0f8ff;
        }
        .status {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { border-left: 5px solid #22c55e; }
        .error { border-left: 5px solid #ef4444; }
        .info { border-left: 5px solid #3b82f6; }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        .script-box {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="status info">
        <h1>üîß Authentication Fix Injector</h1>
        <p>This page will inject authentication fixes to resolve sign-in and UI visibility issues.</p>
    </div>
    
    <div id="status" class="status">
        <h2>Status: Injecting fixes...</h2>
        <div id="progress"></div>
    </div>
    
    <div class="status">
        <h3>Manual Actions:</h3>
        <button onclick="runImmediateFix()">üîß Apply Immediate Fix</button>
        <button onclick="diagnoseSystem()">üîç Diagnose System</button>
        <button onclick="testSignIn()">üß™ Test Sign-In</button>
        <button onclick="forceShowButtons()">üëÅÔ∏è Force Show Buttons</button>
    </div>
    
    <div class="status">
        <h3>Copy & Paste Script (If Auto-Injection Fails):</h3>
        <p>Copy this script and paste it into the browser console (F12 ‚Üí Console):</p>
        <div class="script-box" onclick="selectScript()" id="consoleScript">
// COPY THIS SCRIPT INTO CONSOLE:
const signedInState = document.getElementById('signedInState');
const mobileSignedInState = document.getElementById('mobileSignedInState');
if (signedInState) { 
    signedInState.classList.remove('hidden'); 
    signedInState.style.display = 'flex'; 
    signedInState.style.visibility = 'visible';
}
if (mobileSignedInState) { 
    mobileSignedInState.classList.remove('hidden'); 
    mobileSignedInState.style.display = 'block'; 
    mobileSignedInState.style.visibility = 'visible';
}
const signedOutState = document.getElementById('signedOutState');
const mobileSignedOutState = document.getElementById('mobileSignedOutState');
if (signedOutState) { 
    signedOutState.classList.add('hidden'); 
    signedOutState.style.display = 'none'; 
}
if (mobileSignedOutState) { 
    mobileSignedOutState.classList.add('hidden'); 
    mobileSignedOutState.style.display = 'none'; 
}
console.log('‚úÖ Authentication UI fixed!');
        </div>
    </div>
    
    <script>
        let fixApplied = false;
        
        // Auto-inject the authentication fix
        console.log('üöÄ Auto-injecting authentication fix...');
        
        // Load and apply the fix scripts
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            script.onerror = () => {
                console.error(`Failed to load: ${src}`);
                if (callback) callback(false);
            };
            document.head.appendChild(script);
        }
        
        // Load the bulletproof fix (comprehensive solution)
        loadScript('bulletproof-auth-fix.js', (success) => {
            if (success !== false) {
                console.log('‚úÖ Bulletproof auth fix loaded');
                updateStatus('‚úÖ Bulletproof authentication fixes successfully injected!', 'success');
                fixApplied = true;

                // Apply the fix after a short delay
                setTimeout(() => {
                    runImmediateFix();
                }, 1000);
            } else {
                console.log('‚ö†Ô∏è Bulletproof fix failed, trying instant fix...');

                // Fallback to instant fix
                loadScript('instant-ui-fix.js', (success2) => {
                    if (success2 !== false) {
                        console.log('‚úÖ Instant fix loaded');
                        updateStatus('‚úÖ Authentication fixes successfully injected!', 'success');
                        fixApplied = true;

                        setTimeout(() => {
                            runImmediateFix();
                        }, 1000);
                    } else {
                        updateStatus('‚ùå Auto-injection failed. Use manual script below.', 'error');
                    }
                });
            }
        });
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = `<h2>${message}</h2>`;
        }
        
        function runImmediateFix() {
            console.log('üîß Running immediate authentication fix...');
            
            // Check if user should be signed in
            const hasWelcome = document.body.textContent.includes('Welcome back');
            const hasCurrentUser = window.currentUser;
            const hasStoredUser = localStorage.getItem('visualVibeUser') || localStorage.getItem('currentUser');
            
            const isSignedIn = hasCurrentUser || hasStoredUser || hasWelcome;
            
            console.log('üë§ User signed in status:', isSignedIn);
            
            if (isSignedIn) {
                // Force show signed-in elements
                const signedInElements = [
                    { id: 'signedInState', display: 'flex' },
                    { id: 'mobileSignedInState', display: 'block' },
                    { id: 'welcomeBanner', display: 'block' }
                ];
                
                signedInElements.forEach(({ id, display }) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.remove('hidden');
                        element.style.display = display;
                        element.style.visibility = 'visible';
                        element.style.opacity = '1';
                        console.log(`‚úÖ Fixed ${id}`);
                    }
                });
                
                // Hide signed-out elements
                ['signedOutState', 'mobileSignedOutState'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.classList.add('hidden');
                        element.style.display = 'none';
                        console.log(`üîí Hid ${id}`);
                    }
                });
                
                updateStatus('‚úÖ Signed-in UI elements are now visible!', 'success');
            } else {
                updateStatus('‚ÑπÔ∏è User appears to be signed out', 'info');
            }
            
            // Fix sign-in button
            const signInButtons = document.querySelectorAll('button[onclick*="openSignInModal"]');
            signInButtons.forEach((button, index) => {
                button.onclick = function(e) {
                    e.preventDefault();
                    const modal = document.getElementById('signInModal');
                    if (modal) {
                        modal.style.display = 'flex';
                        modal.classList.remove('hidden');
                        modal.style.zIndex = '9999';
                        console.log('‚úÖ Sign-in modal opened');
                    }
                };
                console.log(`‚úÖ Fixed sign-in button ${index + 1}`);
            });
        }
        
        function diagnoseSystem() {
            console.log('üîç === SYSTEM DIAGNOSTIC ===');
            
            // Check user state
            console.log('üë§ Current User:', window.currentUser);
            console.log('üíæ Stored User:', localStorage.getItem('visualVibeUser'));
            
            // Check UI elements
            const elements = ['signedInState', 'mobileSignedInState', 'signedOutState', 'mobileSignedOutState'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    console.log(`üé® ${id}:`, {
                        found: true,
                        hidden: element.classList.contains('hidden'),
                        display: element.style.display,
                        computed: window.getComputedStyle(element).display
                    });
                } else {
                    console.log(`üé® ${id}: Not found`);
                }
            });
            
            console.log('üîç === END DIAGNOSTIC ===');
            updateStatus('üîç Diagnostic complete - check console for details', 'info');
        }
        
        function testSignIn() {
            console.log('üß™ Testing sign-in functionality...');
            
            // Create test user
            const testUser = {
                id: 'test_user_' + Date.now(),
                name: 'Test User',
                email: 'test@example.com',
                password: 'password123'
            };
            
            let users = [];
            try {
                users = JSON.parse(localStorage.getItem('visualVibeUsers') || '[]');
            } catch (e) {
                users = [];
            }
            
            // Add test user if not exists
            if (!users.find(u => u.email === 'test@example.com')) {
                users.push(testUser);
                localStorage.setItem('visualVibeUsers', JSON.stringify(users));
                console.log('‚úÖ Test user created');
            }
            
            // Simulate sign-in
            window.currentUser = {
                id: testUser.id,
                name: testUser.name,
                email: testUser.email,
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('visualVibeUser', JSON.stringify(window.currentUser));
            
            // Apply UI fix
            runImmediateFix();
            
            updateStatus('üß™ Test sign-in completed! UI should now show signed-in state.', 'success');
        }
        
        function forceShowButtons() {
            console.log('üëÅÔ∏è Force showing all signed-in buttons...');
            
            const elementsToShow = [
                'signedInState', 'mobileSignedInState', 'welcomeBanner'
            ];
            
            elementsToShow.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.classList.remove('hidden');
                    element.style.display = id.includes('mobile') ? 'block' : (id === 'welcomeBanner' ? 'block' : 'flex');
                    element.style.visibility = 'visible';
                    element.style.opacity = '1';
                    console.log(`‚úÖ Force showed ${id}`);
                }
            });
            
            updateStatus('üëÅÔ∏è All signed-in buttons forced to show!', 'success');
        }
        
        function selectScript() {
            const scriptElement = document.getElementById('consoleScript');
            const range = document.createRange();
            range.selectNodeContents(scriptElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        // Auto-run after page load
        setTimeout(() => {
            if (!fixApplied) {
                console.log('‚ö†Ô∏è Auto-fix not applied, trying manual fix...');
                runImmediateFix();
            }
        }, 3000);
    </script>
</body>
</html>
