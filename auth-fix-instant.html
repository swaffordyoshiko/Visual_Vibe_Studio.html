<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Fix - Apply Now</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .status {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .success {
            background: rgba(0, 255, 0, 0.2);
            border-left: 4px solid #00ff00;
        }
        .error {
            background: rgba(255, 0, 0, 0.2);
            border-left: 4px solid #ff0000;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #45a049;
        }
        .danger {
            background: #f44336;
        }
        .danger:hover {
            background: #da190b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Comprehensive Authentication Fix</h1>
        <p>This tool will fix the authentication issues on Visual Vibe Studio:</p>
        <ul>
            <li>‚úÖ Sign-in button will recognize existing customers</li>
            <li>‚úÖ Prevents existing users from signing up again</li>
            <li>‚úÖ Shows "Edit Profile", "My Orders", and "Sign Out" buttons after login</li>
            <li>‚úÖ Unified storage system for better compatibility</li>
        </ul>
        
        <div id="status" class="status">
            <h3>Status: Ready to apply fix</h3>
            <p id="progress">Click "Apply Fix" to start</p>
        </div>
        
        <button onclick="applyAuthFix()">üöÄ Apply Authentication Fix</button>
        <button onclick="testAuthSystem()" class="danger">üß™ Test Authentication</button>
        <button onclick="clearAllData()" class="danger">üóëÔ∏è Clear All User Data</button>
        
        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script>
        console.log('üîß Authentication Fix Tool Loaded');
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            const progressDiv = document.getElementById('progress');
            
            statusDiv.className = `status ${type}`;
            progressDiv.textContent = message;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function applyAuthFix() {
            updateStatus('Applying comprehensive authentication fix...', 'info');
            
            try {
                // Load the comprehensive auth fix script
                const script = document.createElement('script');
                script.src = 'comprehensive-auth-fix.js';
                script.onload = function() {
                    updateStatus('‚úÖ Authentication fix applied successfully!', 'success');
                    
                    // Apply to current window
                    if (window.opener) {
                        try {
                            // Apply fix to parent window
                            const parentScript = window.opener.document.createElement('script');
                            parentScript.src = 'comprehensive-auth-fix.js';
                            window.opener.document.head.appendChild(parentScript);
                            
                            updateStatus('‚úÖ Fix applied to main window!', 'success');
                        } catch (e) {
                            console.warn('Could not apply to parent window:', e);
                        }
                    }
                    
                    // Test the fix
                    setTimeout(testAuthSystem, 1000);
                };
                script.onerror = function() {
                    updateStatus('‚ùå Failed to load authentication fix script', 'error');
                };
                
                document.head.appendChild(script);
                
            } catch (error) {
                updateStatus(`‚ùå Error applying fix: ${error.message}`, 'error');
                console.error('Fix application error:', error);
            }
        }
        
        function testAuthSystem() {
            updateStatus('Testing authentication system...', 'info');
            
            const results = document.getElementById('results');
            let testResults = '<h3>üß™ Authentication Test Results:</h3>';
            
            // Test 1: Check if functions exist
            const requiredFunctions = ['handleSignIn', 'handleSignUp', 'updateAuthUI', 'signOut'];
            const functionResults = requiredFunctions.map(funcName => {
                const exists = typeof window[funcName] === 'function';
                return `<li>${exists ? '‚úÖ' : '‚ùå'} ${funcName}: ${exists ? 'Available' : 'Missing'}</li>`;
            });
            
            testResults += '<h4>Function Availability:</h4><ul>' + functionResults.join('') + '</ul>';
            
            // Test 2: Check storage
            const storageKeys = ['vvs_user', 'visualVibeUsers', 'currentUser'];
            const storageResults = storageKeys.map(key => {
                const data = localStorage.getItem(key);
                return `<li>${data ? '‚úÖ' : '‚ÑπÔ∏è'} ${key}: ${data ? 'Has Data' : 'Empty'}</li>`;
            });
            
            testResults += '<h4>Storage Status:</h4><ul>' + storageResults.join('') + '</ul>';
            
            // Test 3: Check UI elements
            const uiElements = ['signInModal', 'signUpModal', 'signedInState', 'signedOutState'];
            const uiResults = uiElements.map(id => {
                const element = document.getElementById(id);
                return `<li>${element ? '‚úÖ' : '‚ùå'} ${id}: ${element ? 'Found' : 'Missing'}</li>`;
            });
            
            testResults += '<h4>UI Elements:</h4><ul>' + uiResults.join('') + '</ul>';
            
            results.innerHTML = testResults;
            
            updateStatus('‚úÖ Authentication test completed!', 'success');
        }
        
        function clearAllData() {
            if (confirm('‚ö†Ô∏è This will clear ALL user data and sessions. Continue?')) {
                updateStatus('Clearing all user data...', 'info');
                
                // Clear all auth-related localStorage keys
                const keysToRemove = [
                    'vvs_user', 'visualVibeUser', 'visualVibeUsers', 'currentUser',
                    'user_', 'vvs_user_' // These will be cleared by pattern
                ];
                
                // Clear exact matches
                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                });
                
                // Clear pattern matches
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('user_') || key.startsWith('vvs_user_')) {
                        localStorage.removeItem(key);
                    }
                });
                
                // Clear window.currentUser
                if (window.currentUser) {
                    window.currentUser = null;
                }
                
                updateStatus('‚úÖ All user data cleared!', 'success');
                
                // Update results
                document.getElementById('results').innerHTML = '<h3>üóëÔ∏è Data Cleared</h3><p>All authentication data has been removed.</p>';
            }
        }
        
        // Auto-apply fix on page load
        window.addEventListener('load', function() {
            console.log('üöÄ Auto-applying authentication fix...');
            setTimeout(applyAuthFix, 1000);
        });
    </script>
</body>
</html>
