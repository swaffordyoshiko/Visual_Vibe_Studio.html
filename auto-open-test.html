<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto-Open Prevention Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen py-8">
    <div class="max-w-4xl mx-auto px-4">
      <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Auto-Open Prevention Test</h1>
      
      <!-- Status -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-4">Current Issue</h2>
        <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p class="text-red-800 font-medium">‚ùå Edit profile form and change profile picture uploader are still auto-opening</p>
        </div>
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <p class="text-green-800 font-medium">‚úÖ Applied aggressive auto-open prevention fix</p>
        </div>
      </div>
      
      <!-- Test Controls -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-6">Test Controls</h2>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <button onclick="setupUser()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700">
            Setup Test User
          </button>
          <button onclick="testUserClick()" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700">
            üë§ Edit Profile (User Click)
          </button>
          <button onclick="testAutoOpen()" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700">
            ü§ñ Test Auto-Open (Should Block)
          </button>
          <button onclick="testTimedOpen()" class="bg-orange-600 text-white px-4 py-3 rounded-lg hover:bg-orange-700">
            ‚è∞ Test Timed Open (Should Block)
          </button>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <button onclick="clearData()" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700">
            Clear Data
          </button>
          <button onclick="runAllTests()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold">
            üß™ Run All Tests
          </button>
        </div>
      </div>
      
      <!-- Modal Status -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">Modal Status</h3>
        <div id="modalStatus" class="space-y-2 text-sm">
          <div>Checking modal status...</div>
        </div>
      </div>
      
      <!-- Test Results -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Test Results</h3>
        <div id="testLog" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-48 overflow-y-auto">
          <div class="text-cyan-400">Auto-open prevention test ready...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-cyan-400',
        success: 'text-green-400', 
        error: 'text-red-400',
        warning: 'text-yellow-400',
        blocked: 'text-orange-400'
      };
      
      const logEntry = `[${timestamp}] ${message}`;
      
      const logElement = document.getElementById('testLog');
      logElement.innerHTML += `<div class="${colors[type] || colors.info}">${logEntry}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    function updateModalStatus() {
      const statusEl = document.getElementById('modalStatus');
      const profileModal = document.getElementById('profileModal');
      
      let status = '';
      if (profileModal) {
        const isHidden = profileModal.classList.contains('hidden');
        const displayStyle = profileModal.style.display;
        status += `<div>Profile Modal: ${isHidden ? 'Hidden' : 'Visible'} (display: ${displayStyle || 'default'})</div>`;
      } else {
        status += '<div>Profile Modal: Not found</div>';
      }
      
      status += `<div>Current User: ${window.currentUser ? window.currentUser.name : 'None'}</div>`;
      status += `<div>Prevention Fix: ${window.preventAutoOpenFix ? 'Loaded' : 'Not loaded'}</div>`;
      
      statusEl.innerHTML = status;
    }
    
    function setupUser() {
      window.currentUser = {
        id: 'test_user',
        email: 'test@example.com',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User'
      };
      
      log('‚úÖ Test user setup complete', 'success');
      updateModalStatus();
    }
    
    function testUserClick() {
      if (!window.currentUser) {
        log('‚ùå Please setup user first', 'error');
        return;
      }
      
      log('üë§ Simulating genuine user click...', 'info');
      
      // Create a fake button to simulate user interaction
      const button = document.createElement('button');
      button.textContent = 'Edit Profile';
      button.onclick = () => openProfileModal();
      document.body.appendChild(button);
      
      // Simulate click event
      const clickEvent = new MouseEvent('click', {
        bubbles: true,
        cancelable: true,
        view: window
      });
      
      button.dispatchEvent(clickEvent);
      
      // Try to open modal after click
      setTimeout(() => {
        try {
          openProfileModal();
          
          setTimeout(() => {
            const modal = document.getElementById('profileModal');
            if (modal && !modal.classList.contains('hidden')) {
              log('‚úÖ User click: Modal opened successfully', 'success');
              // Close it
              setTimeout(() => {
                if (window.forceCloseProfileModal) {
                  window.forceCloseProfileModal();
                } else if (window.closeProfileModal) {
                  window.closeProfileModal();
                }
              }, 1000);
            } else {
              log('‚ùå User click: Modal failed to open', 'error');
            }
            updateModalStatus();
          }, 500);
        } catch (error) {
          log(`‚ùå User click error: ${error.message}`, 'error');
        }
        
        document.body.removeChild(button);
      }, 100);
    }
    
    function testAutoOpen() {
      log('ü§ñ Testing auto-open (should be blocked)...', 'info');
      
      try {
        // Try to open modal without user interaction
        openProfileModal();
        
        setTimeout(() => {
          const modal = document.getElementById('profileModal');
          if (modal && modal.classList.contains('hidden')) {
            log('‚úÖ Auto-open successfully BLOCKED', 'blocked');
          } else {
            log('‚ùå Auto-open NOT blocked (BUG)', 'error');
          }
          updateModalStatus();
        }, 500);
      } catch (error) {
        log(`‚úÖ Auto-open blocked with error: ${error.message}`, 'blocked');
      }
    }
    
    function testTimedOpen() {
      log('‚è∞ Testing timed auto-open (should be blocked)...', 'info');
      
      // Try opening via setTimeout
      setTimeout(() => {
        try {
          openProfileModal();
          
          setTimeout(() => {
            const modal = document.getElementById('profileModal');
            if (modal && modal.classList.contains('hidden')) {
              log('‚úÖ Timed auto-open successfully BLOCKED', 'blocked');
            } else {
              log('‚ùå Timed auto-open NOT blocked (BUG)', 'error');
            }
            updateModalStatus();
          }, 500);
        } catch (error) {
          log(`‚úÖ Timed auto-open blocked: ${error.message}`, 'blocked');
        }
      }, 100);
    }
    
    function clearData() {
      window.currentUser = null;
      
      // Close any open modals
      const modal = document.getElementById('profileModal');
      if (modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
      }
      
      log('üßπ Data cleared', 'warning');
      updateModalStatus();
    }
    
    function runAllTests() {
      log('üöÄ Running all auto-open prevention tests...', 'info');
      
      clearData();
      setTimeout(() => {
        setupUser();
        setTimeout(() => {
          testAutoOpen();
          setTimeout(() => {
            testTimedOpen();
            setTimeout(() => {
              testUserClick();
              setTimeout(() => {
                log('üéâ All tests completed!', 'success');
              }, 2000);
            }, 1500);
          }, 1500);
        }, 500);
      }, 500);
    }
    
    // Initialize
    log('üéØ Auto-open prevention test initialized');
    updateModalStatus();
    
    // Update status every few seconds
    setInterval(updateModalStatus, 3000);
    
    // Check if prevention fix loaded
    setTimeout(() => {
      if (window.preventAutoOpenFix) {
        log('‚úÖ Aggressive prevention fix loaded', 'success');
      } else {
        log('‚ùå Prevention fix not loaded', 'error');
      }
    }, 1000);
    
  </script>
  
  <!-- Load the prevention fix -->
  <script src="prevent-auto-open-fix.js"></script>
  
</body>
</html>
