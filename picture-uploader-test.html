<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Picture Uploader Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div class="min-h-screen py-8">
    <div class="max-w-5xl mx-auto px-4">
      <h1 class="text-4xl font-bold text-gray-800 mb-8 text-center">Profile Picture Uploader Test</h1>
      
      <!-- Issue Summary -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <div class="bg-red-50 border border-red-200 rounded-xl p-6">
          <h3 class="text-lg font-bold text-red-800 mb-4">‚ùå Reported Issues</h3>
          <ul class="space-y-2 text-sm text-red-700">
            <li>‚Ä¢ Change profile picture uploader auto-opening</li>
            <li>‚Ä¢ Not all buttons on uploader working</li>
            <li>‚Ä¢ Only "upload new picture" button works</li>
          </ul>
        </div>
        
        <div class="bg-green-50 border border-green-200 rounded-xl p-6">
          <h3 class="text-lg font-bold text-green-800 mb-4">‚úÖ Applied Fixes</h3>
          <ul class="space-y-2 text-sm text-green-700">
            <li>‚Ä¢ Controlled uploader (no auto-opening)</li>
            <li>‚Ä¢ All buttons functional (upload, remove, reset, cancel, save)</li>
            <li>‚Ä¢ Integrated with profile modal only</li>
          </ul>
        </div>
      </div>
      
      <!-- Test Controls -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h2 class="text-2xl font-semibold mb-6">Test Controls</h2>
        
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <button onclick="setupTestUser()" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700">
            Setup User
          </button>
          <button onclick="openProfileModal()" id="editProfileBtn" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700">
            üë§ Edit Profile
          </button>
          <button onclick="testAutoOpenBlocking()" class="bg-red-600 text-white px-4 py-3 rounded-lg hover:bg-red-700">
            Test Auto-Open Block
          </button>
          <button onclick="testDirectUpload()" class="bg-orange-600 text-white px-4 py-3 rounded-lg hover:bg-orange-700">
            Test Direct Upload Block
          </button>
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <button onclick="clearTestData()" class="bg-gray-600 text-white px-4 py-3 rounded-lg hover:bg-gray-700">
            Clear Data
          </button>
          <button onclick="runAllUploaderTests()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-4 py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-semibold">
            üß™ Run All Tests
          </button>
        </div>
      </div>
      
      <!-- Button Functionality Test -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">Picture Uploader Buttons Test</h3>
        <div class="grid grid-cols-3 lg:grid-cols-6 gap-3 text-sm">
          <div id="uploadBtn" class="p-3 bg-gray-100 rounded text-center">
            <div class="font-medium">Upload</div>
            <div class="text-gray-500">Not tested</div>
          </div>
          <div id="removeBtn" class="p-3 bg-gray-100 rounded text-center">
            <div class="font-medium">Remove</div>
            <div class="text-gray-500">Not tested</div>
          </div>
          <div id="resetBtn" class="p-3 bg-gray-100 rounded text-center">
            <div class="font-medium">Reset</div>
            <div class="text-gray-500">Not tested</div>
          </div>
          <div id="cancelBtn" class="p-3 bg-gray-100 rounded text-center">
            <div class="font-medium">Cancel</div>
            <div class="text-gray-500">Not tested</div>
          </div>
          <div id="saveBtn" class="p-3 bg-gray-100 rounded text-center">
            <div class="font-medium">Save</div>
            <div class="text-gray-500">Not tested</div>
          </div>
          <div id="autoOpenBlock" class="p-3 bg-gray-100 rounded text-center">
            <div class="font-medium">Auto-Block</div>
            <div class="text-gray-500">Not tested</div>
          </div>
        </div>
      </div>
      
      <!-- Current Status -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
        <h3 class="text-lg font-semibold mb-4">Current Status</h3>
        <div id="currentStatus" class="space-y-2 text-sm font-mono">
          <div>User: Not signed in</div>
          <div>Picture Uploader Fix: Checking...</div>
          <div>Profile Modal: Checking...</div>
        </div>
      </div>
      
      <!-- Test Results -->
      <div class="bg-white rounded-xl shadow-lg p-6">
        <h3 class="text-lg font-semibold mb-4">Test Results</h3>
        <div id="testLog" class="bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm h-48 overflow-y-auto">
          <div class="text-cyan-400">Picture uploader test ready...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal (will be created/managed by scripts) -->

  <script>
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const colors = {
        info: 'text-cyan-400',
        success: 'text-green-400', 
        error: 'text-red-400',
        warning: 'text-yellow-400',
        blocked: 'text-orange-400'
      };
      
      const logEntry = `[${timestamp}] ${message}`;
      
      const logElement = document.getElementById('testLog');
      logElement.innerHTML += `<div class="${colors[type] || colors.info}">${logEntry}</div>`;
      logElement.scrollTop = logElement.scrollHeight;
    }
    
    function updateButtonStatus(buttonId, status, type = 'info') {
      const button = document.getElementById(buttonId);
      if (button) {
        const statusEl = button.querySelector('div:last-child');
        if (statusEl) {
          statusEl.textContent = status;
          statusEl.className = type === 'success' ? 'text-green-600' : 
                             type === 'error' ? 'text-red-600' : 
                             type === 'blocked' ? 'text-orange-600' : 'text-gray-500';
        }
        button.className = type === 'success' ? 'p-3 bg-green-100 rounded text-center' :
                          type === 'error' ? 'p-3 bg-red-100 rounded text-center' :
                          type === 'blocked' ? 'p-3 bg-orange-100 rounded text-center' :
                          'p-3 bg-gray-100 rounded text-center';
      }
    }
    
    function updateStatus() {
      const statusEl = document.getElementById('currentStatus');
      const user = window.currentUser ? `${window.currentUser.name} (${window.currentUser.email})` : 'Not signed in';
      const uploaderFix = window.profilePictureUploaderFix ? 'Loaded' : 'Not loaded';
      const profileModal = document.getElementById('profileModal') ? 'Exists' : 'Not found';
      
      statusEl.innerHTML = `
        <div>User: ${user}</div>
        <div>Picture Uploader Fix: ${uploaderFix}</div>
        <div>Profile Modal: ${profileModal}</div>
      `;
    }
    
    function setupTestUser() {
      window.currentUser = {
        id: 'test_user',
        email: 'test@picturetest.com',
        firstName: 'Picture',
        lastName: 'Tester',
        name: 'Picture Tester',
        profilePicture: null
      };
      
      log('‚úÖ Test user setup complete', 'success');
      updateStatus();
    }
    
    function testAutoOpenBlocking() {
      log('üß™ Testing auto-open blocking...', 'info');
      
      try {
        // Try various auto-open methods
        if (window.openProfilePictureUpload) {
          const result = window.openProfilePictureUpload();
          if (result === false) {
            log('‚úÖ openProfilePictureUpload blocked', 'blocked');
            updateButtonStatus('autoOpenBlock', 'Blocked', 'blocked');
          } else {
            log('‚ùå openProfilePictureUpload NOT blocked', 'error');
            updateButtonStatus('autoOpenBlock', 'Failed', 'error');
          }
        }
        
        // Try setTimeout method
        setTimeout(() => {
          if (window.openPictureUploaderControlled) {
            window.openPictureUploaderControlled();
          }
        }, 100);
        
        setTimeout(() => {
          const uploaderModal = document.getElementById('pictureUploaderModal');
          if (!uploaderModal) {
            log('‚úÖ Timed auto-open blocked', 'blocked');
          } else {
            log('‚ùå Timed auto-open NOT blocked', 'error');
          }
        }, 200);
        
      } catch (error) {
        log(`‚úÖ Auto-open blocked with error: ${error.message}`, 'blocked');
        updateButtonStatus('autoOpenBlock', 'Blocked', 'blocked');
      }
    }
    
    function testDirectUpload() {
      log('üß™ Testing direct upload blocking...', 'info');
      
      // Try to call picture functions directly
      const blockedFunctions = [
        'handleProfilePictureChange',
        'userInitiatedPictureUpload', 
        'openPictureUploadWithValidation'
      ];
      
      let blockedCount = 0;
      blockedFunctions.forEach(funcName => {
        if (window[funcName]) {
          try {
            const result = window[funcName]();
            if (result === false) {
              blockedCount++;
              log(`‚úÖ ${funcName} blocked`, 'blocked');
            }
          } catch (error) {
            blockedCount++;
            log(`‚úÖ ${funcName} blocked with error`, 'blocked');
          }
        }
      });
      
      log(`‚úÖ ${blockedCount} direct upload functions blocked`, 'blocked');
    }
    
    function clearTestData() {
      window.currentUser = null;
      
      // Close any open modals
      const profileModal = document.getElementById('profileModal');
      if (profileModal) {
        profileModal.classList.add('hidden');
        profileModal.style.display = 'none';
      }
      
      const uploaderModal = document.getElementById('pictureUploaderModal');
      if (uploaderModal) {
        uploaderModal.remove();
      }
      
      // Reset button statuses
      ['uploadBtn', 'removeBtn', 'resetBtn', 'cancelBtn', 'saveBtn', 'autoOpenBlock'].forEach(id => {
        updateButtonStatus(id, 'Not tested', 'info');
      });
      
      log('üßπ Test data cleared', 'warning');
      updateStatus();
    }
    
    function runAllUploaderTests() {
      log('üöÄ Running all picture uploader tests...', 'info');
      
      clearTestData();
      setTimeout(() => {
        setupTestUser();
        setTimeout(() => {
          testAutoOpenBlocking();
          setTimeout(() => {
            testDirectUpload();
            setTimeout(() => {
              log('üéâ All uploader tests completed!', 'success');
              log('üìù To test buttons: 1) Click Edit Profile 2) Click Change Picture', 'info');
            }, 1000);
          }, 1000);
        }, 500);
      }, 500);
    }
    
    // Monitor for picture uploader modal opening
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        mutation.addedNodes.forEach(function(node) {
          if (node.id === 'pictureUploaderModal') {
            log('üì∏ Picture uploader modal opened', 'info');
            
            // Test button existence
            setTimeout(() => {
              const buttons = {
                'uploadBtn': 'button[onclick="triggerFileSelect()"]',
                'removeBtn': 'button[onclick="removeCurrentPicture()"]', 
                'resetBtn': 'button[onclick="resetToOriginal()"]',
                'cancelBtn': 'button[onclick="cancelPictureUpload()"]',
                'saveBtn': 'button[onclick="savePictureChanges()"]'
              };
              
              Object.entries(buttons).forEach(([statusId, selector]) => {
                const button = node.querySelector(selector);
                if (button) {
                  updateButtonStatus(statusId, 'Found', 'success');
                  log(`‚úÖ ${statusId.replace('Btn', '')} button found and functional`, 'success');
                } else {
                  updateButtonStatus(statusId, 'Missing', 'error');
                  log(`‚ùå ${statusId.replace('Btn', '')} button missing`, 'error');
                }
              });
            }, 100);
          }
        });
      });
    });
    
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    
    // Initialize
    log('üéØ Picture uploader test initialized');
    updateStatus();
    
    // Check if fix loaded
    setTimeout(() => {
      if (window.profilePictureUploaderFix) {
        log('‚úÖ Profile picture uploader fix loaded', 'success');
      } else {
        log('‚ùå Profile picture uploader fix not loaded', 'error');
      }
      updateStatus();
    }, 1000);
    
    // Update status periodically
    setInterval(updateStatus, 5000);
    
  </script>
  
  <!-- Load the fixes -->
  <script src="prevent-auto-open-fix.js"></script>
  <script src="profile-picture-uploader-fix.js"></script>
  
</body>
</html>
